{{- define "embed" -}}{{ $src := .Get "src" }}{{ if not (hasPrefix $src "/") }}{{ $base_path := .Get "base_path" }}{{ $src = (path.Join $base_path $src) }}{{ end }}{{ $file_content := $src | readFile }}{{ $lines := split $file_content "\n" }}{{ $ignore_line := false }}{{ $start_stop_ignoring := false }}{{ $html_content := newScratch }}{{ $html_content.Set "lines" "" }}{{ range $index, $line := $lines }}{{ $start_stop_ignoring = false }}{{ if hasPrefix $line "---" }}{{ $start_stop_ignoring = true }}{{ end }}{{ if and (not $ignore_line) (not $start_stop_ignoring) }}{{ $shortcodes := findRE "{{%([^%]|[^%][^}]|[^%][^}][^}])*%}}" $line }}{{ if gt (len $shortcodes) 0 }}{{ warnf "%s" ($html_content.Get "lines") }}{{ $html_content.Get "lines" | safeHTML }}{{ $html_content.Set "lines" "" }}{{ $params := newScratch }}{{ $params.Set "base_path" (path.Dir $src) }}{{ $params.Set "line" $line }}{{ $params.Set "shortcodes" $shortcodes }}{{ template "apply_shortcodes" $params }}{{ else }}{{ $html_content.Add "lines" $line }}{{ $html_content.Add "lines" "\n" }}{{ end }}{{ end }}{{ if $start_stop_ignoring }}{{ $ignore_line = not $ignore_line }}{{ end }}{{ end }}{{ $html_content.Get "lines" | safeHTML }}{{- end -}}